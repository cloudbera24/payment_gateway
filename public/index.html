<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CHEGE TECH SUBSCRIPTIONS</title>
  <style>
    /* Simple, clean responsive UI */
    :root{
      --card-bg: #ffffff;
      --page-bg-1: #0f172a;
      --page-bg-2: #334155;
      --accent: #06b6d4;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--page-bg-1),var(--page-bg-2));
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .app {
      width:100%;
      max-width:980px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      padding:22px;
      backdrop-filter: blur(6px);
    }
    header{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:56px;height:56px;border-radius:10px;
      background: linear-gradient(135deg,var(--accent),#7c3aed);
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#001;
      box-shadow: 0 6px 18px rgba(12,74,110,0.18);
      font-size:20px;
    }
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .catalog {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
      margin-top:10px;
    }
    .card {
      background:var(--card-bg);
      color:#0b1220;
      border-radius:12px;
      padding:14px;
      box-shadow: 0 6px 18px rgba(3,7,18,0.06);
    }
    .card h3{margin:0 0 8px 0;font-size:16px}
    .price{font-weight:700;font-size:18px;margin-bottom:12px}
    .btn{
      display:inline-block;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
    }
    .btn-primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#04202a}
    .btn-ghost{background:transparent;border:1px solid rgba(11,17,25,0.06);color:#04202a}
    .footer{
      margin-top:18px;padding-top:12px;border-top:1px dashed rgba(255,255,255,0.04);
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      color:var(--muted);font-size:13px;
    }

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:90}
    .modal{width:100%;max-width:420px;background:var(--card-bg);color:#081126;border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(2,6,23,0.45)}
    .modal h2{margin:0 0 8px 0}
    label{display:block;font-size:13px;margin-top:8px;color:#243447}
    input[type="text"], input[type="tel"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf3;margin-top:6px;font-size:15px
    }
    .modal-foot{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
    .muted{color:var(--muted);font-size:13px}

    /* Result / toast */
    .toast{
      position:fixed;right:18px;bottom:18px;background:#0b1220;color:#e6eef8;padding:12px 14px;border-radius:10px;box-shadow:0 8px 34px rgba(2,6,23,0.6);
      z-index:120;font-weight:600
    }

    @media (max-width:640px){
      body{padding:18px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="app-title">
    <header>
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <h1 id="app-title">CHEGE TECH SUBSCRIPTIONS</h1>
          <div class="sub">Secure payments via M-Pesa · Managed by CHEGE TECH</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="sub">Account ID: <strong>3342</strong></div>
        <div style="margin-top:6px"><span style="background:#10b981;color:#021; padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px">LIVE</span></div>
      </div>
    </header>

    <main>
      <section>
        <p class="muted">Choose a subscription plan below. Click <strong>Subscribe</strong> to proceed with payment via your phone.</p>

        <div class="catalog" id="plansContainer">
          <!-- Plan cards injected by JS -->
        </div>
      </section>

      <div class="footer">
        <div>Powered by PayHero · Managed by CHEGE TECH</div>
        <div class="muted">After successful payment you will be redirected to WhatsApp.</div>
      </div>
    </main>
  </div>

  <!-- Modal (hidden by default) -->
  <div id="modalBackdrop" style="display:none" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h2 id="modalTitle">Subscribe</h2>
      <div id="planSummary" class="muted" style="margin-top:6px">Plan details...</div>

      <form id="subscribeForm" style="margin-top:12px">
        <label for="phone">Phone number (2547XXXXXXXX)</label>
        <input id="phoneInput" name="phone" type="tel" inputmode="tel" placeholder="254712345678" required />

        <label for="name">Your name (optional)</label>
        <input id="nameInput" name="name" type="text" placeholder="John Doe" />

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <input id="agreement" type="checkbox" checked />
          <label for="agreement" style="font-size:13px;color:#243447;margin:0">I confirm I will complete payment on my phone</label>
        </div>

        <div class="modal-foot">
          <button type="button" id="cancelBtn" class="btn btn-ghost">Cancel</button>
          <button type="submit" id="confirmBtn" class="btn btn-primary">Confirm & Pay</button>
        </div>
      </form>

      <div id="modalNotice" style="margin-top:10px;font-size:13px;color:#556b7a"></div>
    </div>
  </div>

  <!-- Optional toast -->
  <div id="toast" style="display:none" class="toast" role="status" aria-live="polite"></div>

  <script>
    /****************************************************************************************
     * CHEGE TECH SUBSCRIPTIONS - Frontend
     * Uses your existing backend endpoints:
     *   POST /api/stk-push      -> initiate STK push (server.js already handles)
     *   GET  /api/transaction-status/:reference -> check status
     *
     * Behavior:
     *  - select plan -> modal -> submit phone -> call /api/stk-push
     *  - on success -> redirect to WhatsApp: +254781287381 with plan & amount
     *
     * IMPORTANT:
     *  - Keep server.js as-is.
     *  - This file expects the server to return result.success === true and
     *    include data.reference (or result.data.reference).
     ****************************************************************************************/

    const PLANS = [
      { id: 'netflix',     name: 'Netflix account',       price: 220 },
      { id: 'spotify',     name: 'Spotify premium',       price: 180 },
      { id: 'showmax',     name: 'Showmax',               price: 150 },
      { id: 'primevideo',  name: 'Prime video',           price: 200 },
      { id: 'expressvpn',  name: 'Express VPN',           price: 150 },
      { id: 'nordvpn',     name: 'Nord VPN',              price: 250 },
      { id: 'surfshark',   name: 'Surfshark VPN',         price: 300 },
      { id: 'whatsappbot', name: 'WhatsApp bot',          price: 60  },
      { id: 'hdo',         name: 'HDO premium',           price: 150 },
      { id: 'panels',      name: 'Unlimited panels',      price: 100 },
      { id: 'canva',       name: 'Canva Pro',             price: 80  },
      { id: 'capcut',      name: 'CapCut Pro',            price: 300 }
    ];

    const WHATSAPP_NUMBER = '254781287381'; // target number for redirection

    const plansContainer = document.getElementById('plansContainer');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const planSummary = document.getElementById('planSummary');
    const modalTitle = document.getElementById('modalTitle');
    const subscribeForm = document.getElementById('subscribeForm');
    const phoneInput = document.getElementById('phoneInput');
    const nameInput = document.getElementById('nameInput');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const modalNotice = document.getElementById('modalNotice');
    const toast = document.getElementById('toast');

    let selectedPlan = null;
    const API_BASE = '/api';

    // Render plan cards
    function renderPlans(){
      plansContainer.innerHTML = '';
      PLANS.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${escapeHtml(p.name)}</h3>
          <div class="price">KES ${p.price.toFixed(0)}</div>
          <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
            <div class="muted" style="font-size:13px">Monthly</div>
            <div>
              <button class="btn btn-primary" data-plan="${p.id}">Subscribe</button>
            </div>
          </div>
        `;
        plansContainer.appendChild(card);
      });

      // attach click listeners
      document.querySelectorAll('[data-plan]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-plan');
          openSubscribeModal(PLANS.find(x=>x.id===id));
        });
      });
    }

    function openSubscribeModal(plan){
      selectedPlan = plan;
      modalTitle.textContent = `Subscribe — ${plan.name}`;
      planSummary.textContent = `${plan.name} · KES ${plan.price}`;
      phoneInput.value = '';
      nameInput.value = '';
      modalNotice.textContent = 'You will receive an M-Pesa prompt on your phone to complete payment.';
      modalBackdrop.style.display = 'flex';
      phoneInput.focus();
    }

    cancelBtn.addEventListener('click', ()=>{
      closeModal();
    });

    function closeModal(){
      modalBackdrop.style.display = 'none';
      selectedPlan = null;
    }

    // form submission -> call /api/stk-push
    subscribeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!selectedPlan) return;

      // basic validation & formatting
      let phone = phoneInput.value.trim();
      if (!phone) {
        showToast('Enter phone number in format 2547XXXXXXXX');
        phoneInput.focus();
        return;
      }
      // normalize: if starts with 0 => 254..., if + => strip +
      if (phone.startsWith('0')) phone = '254' + phone.slice(1);
      if (phone.startsWith('+')) phone = phone.slice(1);

      if (!/^2547\d{8}$/.test(phone)) {
        showToast('Phone must be in format 2547XXXXXXXX');
        phoneInput.focus();
        return;
      }

      const customerName = nameInput.value.trim() || 'Customer';
      const amount = selectedPlan.price;
      const external_reference = `CHEGE-${selectedPlan.id.toUpperCase()}-${Date.now().toString(36).slice(-6)}`;

      // UI state
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      try {
        showToast('Initiating STK Push — check your phone for the M-Pesa prompt');

        const payload = {
          phone_number: phone,
          amount: amount,
          external_reference,
          customer_name: customerName
        };

        const resp = await fetch(`${API_BASE}/stk-push`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        const result = await resp.json();

        if (result && result.success) {
          // use the reference from server if present
          const ref = (result.data && (result.data.reference || result.data.external_reference || result.data.checkout_reference)) || external_reference;
          
          showToast('Payment initiated successfully! Redirecting to WhatsApp...');
          // build whatsapp message
          const msg = `Hello CHEGE TECH! I just subscribed for ${selectedPlan.name} at KES ${amount}. TransactionRef: ${encodeURIComponent(ref)}`;
          const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;

          // show short success notice in modal then redirect
          modalNotice.innerHTML = `✅ STK Push initiated. Transaction reference: <strong>${escapeHtml(ref)}</strong><br>Redirecting to WhatsApp...`;
          
          // small delay so user sees success (2 seconds)
          setTimeout(()=> {
            // redirect
            window.location.href = waUrl;
          }, 2000);

        } else {
          // server returned success: false
          const errMsg = (result && result.error) ? result.error : 'Payment initiation failed';
          showToast('❌ ' + errMsg);
          modalNotice.textContent = `Error: ${errMsg}`;
        }

      } catch (err) {
        console.error(err);
        showToast('Network error: ' + (err.message || err));
        modalNotice.textContent = 'Network error: ' + (err.message || err);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm & Pay';
      }
    });

    // small utility: toast
    let toastTimer = null;
    function showToast(text, timeout = 3500){
      toast.textContent = text;
      toast.style.display = 'block';
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> {
        toast.style.display = 'none';
      }, timeout);
    }

    // small escaping util
    function escapeHtml(str){
      if (!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // Init
    renderPlans();

    // Optional: quick health-check on load (non-blocking)
    (async function healthCheck(){
      try {
        const r = await fetch(`${API_BASE}/health`);
        // We don't need to do anything with it; keeping it for console visibility
        const json = await r.json();
        console.log('Health:', json);
      } catch(e){
        console.warn('Health check failed', e);
      }
    })();
  </script>
</body>
              </html>
